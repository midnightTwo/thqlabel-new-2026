-- ========================================
-- –°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ –ù–û–í–û–°–¢–ï–ô THQ LABEL
-- ========================================
-- –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–æ–≤–æ—Å—Ç–µ–π:
-- ‚úì –¢–∞–±–ª–∏—Ü—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ—Å—Ç–µ–π
-- ‚úì –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (RLS) - –∫—Ç–æ –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/—Å–æ–∑–¥–∞–≤–∞—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
-- ‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è
-- ‚úì –¢–µ—Å—Ç–æ–≤—É—é –Ω–æ–≤–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

-- –®–ê–ì 1: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ç–∞–±–ª–∏—Ü—É (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
-- –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
DROP TABLE IF EXISTS news CASCADE;

-- –®–ê–ì 2: –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É news
-- –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –ª–µ–π–±–ª–∞
CREATE TABLE news (
  id BIGSERIAL PRIMARY KEY,              -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –Ω–æ–≤–æ—Å—Ç–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  title TEXT NOT NULL,                   -- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
  content TEXT,                          -- –¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)
  category TEXT DEFAULT '–ù–æ–≤–æ—Å—Ç—å',       -- –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ù–æ–≤–æ—Å—Ç—å, –†–µ–ª–∏–∑, –ê–Ω–æ–Ω—Å, –∏ —Ç.–¥.
  image TEXT,                            -- –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
  created_at TIMESTAMPTZ DEFAULT NOW(),  -- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  updated_at TIMESTAMPTZ DEFAULT NOW()   -- –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
);

-- –®–ê–ì 3: –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã
-- –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ –¥–∞—Ç–µ
CREATE INDEX idx_news_created_at ON news(created_at DESC);

-- –®–ê–ì 4: –í–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (RLS)
-- Row Level Security - –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫
ALTER TABLE news ENABLE ROW LEVEL SECURITY;

-- ========================================
-- –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–ê
-- ========================================

-- –ü–û–õ–ò–¢–ò–ö–ê 1: –ß—Ç–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π
-- –ö–¢–û: –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–¥–∞–∂–µ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
-- –ß–¢–û –ú–û–ñ–ï–¢: –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /news
DROP POLICY IF EXISTS "Enable read for all" ON news;
CREATE POLICY "Enable read for all"
  ON news FOR SELECT
  USING (true);

-- –ü–û–õ–ò–¢–ò–ö–ê 1: –ß—Ç–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π
-- –ö–¢–û: –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–¥–∞–∂–µ –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
-- –ß–¢–û –ú–û–ñ–ï–¢: –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /news
DROP POLICY IF EXISTS "Enable read for all" ON news;
CREATE POLICY "Enable read for all"
  ON news FOR SELECT
  USING (true);

-- –ü–û–õ–ò–¢–ò–ö–ê 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π
-- –ö–¢–û: –¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Ä–æ–ª—å—é 'admin' –≤ —Ç–∞–±–ª–∏—Ü–µ profiles
-- –ß–¢–û –ú–û–ñ–ï–¢: –ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
DROP POLICY IF EXISTS "Enable insert for admins" ON news;
CREATE POLICY "Enable insert for admins"
  ON news FOR INSERT
  TO authenticated
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- –ü–û–õ–ò–¢–ò–ö–ê 3: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π
-- –ö–¢–û: –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã
-- –ß–¢–û –ú–û–ñ–ï–¢: –ò–∑–º–µ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç, –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ª—é–±–æ–π –Ω–æ–≤–æ—Å—Ç–∏
DROP POLICY IF EXISTS "Enable update for admins" ON news;
CREATE POLICY "Enable update for admins"
  ON news FOR UPDATE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- –ü–û–õ–ò–¢–ò–ö–ê 4: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π
-- –ö–¢–û: –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã
-- –ß–¢–û –ú–û–ñ–ï–¢: –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—è—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
DROP POLICY IF EXISTS "Enable delete for admins" ON news;
CREATE POLICY "Enable delete for admins"
  ON news FOR DELETE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- ========================================
-- –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø
-- ========================================

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è
-- –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏ updated_at –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- –¢—Ä–∏–≥–≥–µ—Ä: –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º UPDATE
DROP TRIGGER IF EXISTS update_news_updated_at ON news;
CREATE TRIGGER update_news_updated_at
  BEFORE UPDATE ON news
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ========================================
-- –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï
-- ========================================

-- –°–æ–∑–¥–∞—ë–º –ø–µ—Ä–≤—É—é –Ω–æ–≤–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
INSERT INTO news (title, content, category, image) VALUES 
(
  '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ thq label!',
  '–≠—Ç–æ –ø–µ—Ä–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ.

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "üì∞ –ù–æ–≤–æ—Å—Ç–∏"
- –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –Ω–æ–≤–æ—Å—Ç—å
- –ù–æ–≤–æ—Å—Ç—å —Å—Ä–∞–∑—É –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /news

–£–¥–∞—á–∏!',
  '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ',
  'https://novayagazeta.ru/static/records/bec4ac4a0d544693a4f4414fe4d50a0d.jpeg'
);

-- ========================================
-- –ü–†–û–í–ï–†–ö–ê –£–°–¢–ê–ù–û–í–ö–ò
-- ========================================

-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
SELECT 
  id AS "ID",
  title AS "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
  category AS "–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
  created_at AS "–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"
FROM news 
ORDER BY created_at DESC;
