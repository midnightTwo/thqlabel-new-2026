export interface ContractFormData {
  fullName: string;
  country: string;
  passport: string;
  passportIssuedBy: string;
  passportCode: string;
  passportDate: string;
  email: string;
  bankAccount: string;
  bankBik: string;
  bankCorr: string;
  cardNumber: string;
}

export function getEmptyContractData(): ContractFormData {
  return {
    fullName: '',
    country: '',
    passport: '',
    passportIssuedBy: '',
    passportCode: '',
    passportDate: '',
    email: '',
    bankAccount: '',
    bankBik: '',
    bankCorr: '',
    cardNumber: '',
  };
}

// Склонение ФИО в творительный падеж (упрощённая версия)
export function toInstrumentalCase(fullName: string): string {
  if (!fullName.trim()) return fullName;
  const parts = fullName.trim().split(/\s+/);
  
  const declinePart = (word: string, index: number): string => {
    if (!word) return word;
    const lower = word.toLowerCase();
    
    // Фамилия (index 0)
    if (index === 0) {
      if (lower.endsWith('ов') || lower.endsWith('ев') || lower.endsWith('ёв')) return word + 'ым';
      if (lower.endsWith('ин') || lower.endsWith('ын')) return word + 'ым';
      if (lower.endsWith('ий')) return word.slice(0, -2) + 'им';
      if (lower.endsWith('ой')) return word.slice(0, -2) + 'ым';
      if (lower.endsWith('ая')) return word.slice(0, -2) + 'ой';
      if (lower.endsWith('яя')) return word.slice(0, -2) + 'ей';
      if (lower.endsWith('а')) return word.slice(0, -1) + 'ой';
      if (lower.endsWith('я')) return word.slice(0, -1) + 'ей';
      return word + 'ом';
    }
    
    // Имя (index 1)
    if (index === 1) {
      if (lower.endsWith('й')) return word.slice(0, -1) + 'ем';
      if (lower.endsWith('ь')) return word.slice(0, -1) + 'ем';
      if (lower.endsWith('а')) return word.slice(0, -1) + 'ой';
      if (lower.endsWith('я')) return word.slice(0, -1) + 'ей';
      return word + 'ом';
    }
    
    // Отчество (index 2)
    if (index === 2) {
      if (lower.endsWith('ич')) return word + 'ем';
      if (lower.endsWith('вна') || lower.endsWith('чна')) return word.slice(0, -1) + 'ой';
      return word + 'ом';
    }
    
    return word;
  };
  
  return parts.map((p, i) => declinePart(p, i)).join(' ');
}

// Сокращение страны
export function shortCountry(country: string): string {
  const lower = country.toLowerCase().trim();
  if (lower === 'россия' || lower === 'российская федерация' || lower === 'рф') return 'РФ';
  return country;
}

// Генерация номера договора
export function generateContractNumber(releaseId: string): string {
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const shortId = releaseId.slice(0, 8).toUpperCase();
  return `thqlabel-${year}${month}-${shortId}`;
}

// Форматирование даты
export function formatContractDate(date?: Date): string {
  const d = date || new Date();
  const months = [
    'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
    'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
  ];
  return `«${d.getDate()}» ${months[d.getMonth()]} ${d.getFullYear()} г.`;
}

// Валидация
export function validateContractField(field: keyof ContractFormData, value: string): string | null {
  switch (field) {
    case 'fullName':
      if (!value.trim()) return 'Введите ФИО';
      if (value.trim().split(/\s+/).length < 2) return 'Введите полное ФИО (минимум фамилия и имя)';
      if (/\d/.test(value)) return 'ФИО не должно содержать цифры';
      return null;
      
    case 'country':
      if (!value.trim()) return 'Введите страну';
      if (/\d/.test(value)) return 'Страна не должна содержать цифры';
      return null;
      
    case 'passport':
      if (!value.trim()) return 'Введите серию и номер паспорта';
      if (!/^\d[\d\s]{5,}$/.test(value.replace(/\s/g, '').length >= 6 ? value : '')) {
        const digitsOnly = value.replace(/\D/g, '');
        if (digitsOnly.length < 6) return 'Минимум 6 цифр';
      }
      return null;
      
    case 'passportIssuedBy':
      if (!value.trim()) return 'Введите кем выдан паспорт';
      return null;
      
    case 'passportCode':
      if (!value.trim()) return 'Введите код подразделения';
      if (!/^\d{3}-?\d{3}$/.test(value.replace(/\s/g, ''))) return 'Формат: XXX-XXX';
      return null;
      
    case 'passportDate':
      if (!value.trim()) return 'Введите дату выдачи';
      return null;
      
    case 'email':
      if (!value.trim()) return 'Введите email';
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'Некорректный email';
      return null;
      
    case 'bankAccount':
      // Необязательно если есть карта
      return null;
      
    case 'bankBik':
      // Необязательно если есть карта
      return null;
      
    case 'bankCorr':
      // Необязательно если есть карта
      return null;
      
    case 'cardNumber':
      // Необязательно если есть счет
      return null;
      
    default:
      return null;
  }
}

// Проверка обязательных полей
export function isContractFormValid(data: ContractFormData): boolean {
  const requiredFields: (keyof ContractFormData)[] = [
    'fullName', 'country', 'passport', 'passportIssuedBy', 
    'passportCode', 'passportDate', 'email'
  ];
  
  for (const field of requiredFields) {
    if (validateContractField(field, data[field]) !== null) return false;
  }
  
  // Нужны либо банковские реквизиты, либо номер карты
  const hasBankDetails = data.bankAccount.trim() && data.bankBik.trim();
  const hasCard = data.cardNumber.trim();
  
  if (!hasBankDetails && !hasCard) return false;
  
  return true;
}

// Форматирование паспортного кода (XXX-XXX)
export function formatPassportCode(value: string): string {
  const digits = value.replace(/\D/g, '').slice(0, 6);
  if (digits.length > 3) {
    return digits.slice(0, 3) + '-' + digits.slice(3);
  }
  return digits;
}

// Форматирование номера карты (XXXX XXXX XXXX XXXX)
export function formatCardNumber(value: string): string {
  const digits = value.replace(/\D/g, '').slice(0, 16);
  return digits.replace(/(.{4})/g, '$1 ').trim();
}

// Форматирование номера счета (20 цифр)
export function formatBankAccount(value: string): string {
  return value.replace(/\D/g, '').slice(0, 20);
}

// Форматирование БИК (9 цифр)
export function formatBik(value: string): string {
  return value.replace(/\D/g, '').slice(0, 9);
}

// Форматирование корр. счета (20 цифр)
export function formatCorrAccount(value: string): string {
  return value.replace(/\D/g, '').slice(0, 20);
}

// ============================================================================
// Генерация HTML-строки полного договора — для экспорта в DOC/PDF
// ============================================================================
export interface ContractExportData {
  fullName: string;
  country: string;
  passport: string;
  passportIssuedBy: string;
  passportCode: string;
  passportDate: string;
  email: string;
  bankAccount?: string;
  bankBik?: string;
  bankCorr?: string;
  cardNumber?: string;
}

export function generateContractHtml(opts: {
  data: ContractExportData;
  contractNumber: string;
  nickname: string;
  tracks: Array<{ title: string; duration?: string }>;
  signatureDataUrl?: string;
  plotnikovSignatureDataUrl?: string;
  contractDate?: string;
}): string {
  const { data, contractNumber, nickname, tracks, signatureDataUrl, plotnikovSignatureDataUrl } = opts;
  const countryShort = shortCountry(data.country);
  const fullNameInstr = toInstrumentalCase(data.fullName);
  const dateStr = opts.contractDate || formatContractDate(new Date());
  const plotSig = plotnikovSignatureDataUrl || '/rospis.png';

  const sigBlock = () => `
    <table style="width:100%;margin-top:24px;font-size:11px;text-align:center;border:none;">
      <tr style="border:none;">
        <td style="border:none;width:50%;vertical-align:top;padding:8px;">
          <p style="font-weight:600;margin-bottom:8px;">Лицензиар</p>
          ${signatureDataUrl ? `<img src="${signatureDataUrl}" style="height:40px;object-fit:contain;display:block;margin:0 auto 4px;" /><p style="font-style:italic;font-size:10px;margin:0;">/${data.fullName}/</p>` : `<p style="font-style:italic;margin:0;">/${data.fullName}/</p>`}
        </td>
        <td style="border:none;width:50%;vertical-align:top;padding:8px;">
          <p style="font-weight:600;margin-bottom:8px;">Лицензиат</p>
          <p style="font-size:9px;opacity:0.85;margin:0 0 4px;">физическое лицо, применяющее специальный налоговый режим «Налог на профессиональный доход (НПД)»</p>
          ${plotSig ? `<img src="${plotSig}" style="height:40px;object-fit:contain;display:block;margin:0 auto 4px;" />` : ''}<p style="font-style:italic;font-size:10px;margin:0;">/Плотников Никита Владимирович/</p>
        </td>
      </tr>
    </table>`;

  // Приложение 2 - таблица с 7 колонками согласно образцу
  const trackRows = tracks.length > 0 
    ? tracks.map((t, i) => `<tr><td style="border:1px solid #000;padding:4px 6px;text-align:center;font-weight:bold;">${i+1}</td><td style="border:1px solid #000;padding:4px 6px;font-weight:600;">${t.title||'—'}</td><td style="border:1px solid #000;padding:4px 6px;text-align:center;">${t.duration||'—'}</td><td style="border:1px solid #000;padding:4px 6px;">${data.fullName}</td><td style="border:1px solid #000;padding:4px 6px;">${data.fullName}</td><td style="border:1px solid #000;padding:4px 6px;">${nickname}</td><td style="border:1px solid #000;padding:4px 6px;">${data.fullName}</td><td style="border:1px solid #000;padding:4px 6px;text-align:center;">1 год</td></tr>`).join('')
    : `<tr><td colspan="8" style="border:1px solid #000;padding:8px;text-align:center;opacity:0.5;">Треки не добавлены</td></tr>`;

  return `
<div style="font-family:'Times New Roman',Georgia,serif;font-size:12px;line-height:1.6;color:#000;">

<!-- Header + Preamble -->
<div>
<h2 style="text-align:center;font-size:14px;font-weight:700;">ЛИЦЕНЗИОННЫЙ ДОГОВОР № ${contractNumber}</h2>
<div style="display:flex;justify-content:space-between;margin-top:4px;"><span>г. Ростов-на-Дону</span><span>${dateStr}</span></div>

<p style="text-indent:24px;margin:10px 0;">
Гражданин ${countryShort} <strong>${data.fullName}</strong>, действующий от своего имени и в своем интересе, именуемый в дальнейшем «Лицензиар», с одной стороны, и Гражданин Российской Федерации <strong>Плотников Никита Владимирович</strong>, физическое лицо, применяющее специальный налоговый режим «Налог на профессиональный доход (НПД)», именуемый в дальнейшем «Лицензиат», с другой стороны, именуемые совместно – «Стороны», а по отдельности «Сторона», заключили настоящий договор (далее — «Договор»), о нижеследующем:
</p>
</div>

<!-- Section 1 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">1. Терминология, используемая в Договоре</h3>
<p style="text-indent:24px;"><strong>Произведение</strong> — музыкальное произведение с текстом, сведения о котором указаны в Приложениях к Договору;</p>
<p style="text-indent:24px;"><strong>Исполнение</strong> — представление ${fullNameInstr || '___'} (Исполнитель – «${nickname || '___'}») (далее – «исполнитель») Произведения посредством пения (или игры на музыкальных инструментах) в живом исполнении и/или с помощью технических средств;</p>
<p style="text-indent:24px;"><strong>Фонограмма</strong> — исключительно звуковая запись Исполнения Произведения, наименование и изготовитель которой указаны в Приложениях к настоящему Договору;</p>
<p style="text-indent:24px;"><strong>Объекты</strong> — Произведения и/или Исполнения и/или Фонограммы, исключительные права на которые принадлежат Лицензиару, а также любые их части, которые в соответствии с действующим законодательством относятся к результатам интеллектуальной деятельности;</p>
<p style="text-indent:24px;"><strong>Караоке</strong> — форма использования Произведения, существующая в форме технической переработки аудиозаписи и/или видеозаписи (механической, магнитной, цифровой, оптической и так далее), предназначенная для использования в качестве аккомпанемента вокального исполнения;</p>
<p style="text-indent:24px;"><strong>Мобильный контент</strong> — собирательно рингтоны, реалтоны, рингбэктоны, фуллтреки, а также любые иные объекты, созданные с использованием Произведений, предназначенные для использования в мобильных устройствах (в т.ч. телефонах, смартфонах, КПК и иных аналогичных устройствах);</p>
<p style="text-indent:24px;"><strong>Файлы</strong> — Произведение и/или Исполнение и Фонограмма в любых цифровых форматах, как известных в настоящем, так и тех, которые могут появиться в будущем;</p>
<p style="text-indent:24px;"><strong>Контент</strong> — Караоке, Мобильный контент и/или Файлы при их совместном упоминании в Договоре;</p>
<p style="text-indent:24px;"><strong>ЦЭР</strong> — цифровое электронное распространение, т.е. распространение Объектов в форме Файлов каким-либо способом, существующим в настоящий момент или изобретенным в будущем, в том числе посредством телефонной, спутниковой, телевизионной, кабельной связи или посредством ресурсов сети Интернет;</p>
<p style="text-indent:24px;"><strong>Исходный материал</strong> — материальные носители эталонного качества, содержащие записи экземпляров Объектов в формате «.WAV», пригодные для воспроизведения Объектов всеми способами, предусмотренными Договором;</p>
<p style="text-indent:24px;"><strong>Срок</strong> — период времени, на который Лицензиар предоставляет Лицензиату право использования Объектов. Срок в отношении каждого из Объектов исчисляется с даты подписания соответствующего Приложения к Договору, содержащего наименование Объекта, и составляет срок действия исключительного права на соответствующий Объект, если иное не предусмотрено Приложением.</p>
<p style="text-indent:24px;"><strong>Территория</strong> — означает территорию всех стран мира, если иное не указано в Приложениях к Договору.</p>
<p style="text-indent:24px;margin-top:6px;">Термины, не указанные выше, соответствуют терминам, указанным в действующем Гражданском Кодексе Российской Федерации (далее – ГК РФ), а в случае отсутствия какого-либо термина в вышеуказанном ГК РФ, обычаям делового оборота и терминам, применяемым при аналогичных правоотношениях в аналогичной ситуации.</p>
</div>

<!-- Section 2 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">2. Предмет Договора</h3>
<p style="text-indent:24px;">2.1. Лицензиар за вознаграждение предоставляет Лицензиату на исключительной основе на Территорию и Срок право использования Объектов, указанных в Приложениях к Договору, следующими способами:</p>
<p style="margin-left:24px;margin-top:6px;"><strong>«Цифровая дистрибуция»</strong></p>
<p style="margin-left:24px;">2.1.1. Перерабатывать Объекты, в том числе технически, в следующих целях и следующими способами, для последующего использования способами, предусмотренными Договором:</p>
<p style="margin-left:24px;">- перерабатывать Объекты в целях создания Контента (в т.ч. Караоке) и рекламного материала Контента, т.е. частей Контента, используемых для продвижения Объектов на цифровых площадках;</p>
<p style="margin-left:24px;">- путём их конвертации в любые известные цифровые форматы в целях создания на их основе Контента;</p>
<p style="margin-left:24px;">- изменять длительность Объектов с целью сокращения хронометража для последующего фрагментарного использования;</p>
<p style="margin-left:24px;">2.1.2. Воспроизводить экземпляры Объектов в любом формате на Носителях без ограничения по тиражу, а также воспроизводить (записывать) Объекты в любом формате (цифровой форме), в том числе в форме Контента, в памяти ЭВМ и иных технических устройств, совместимых с памятью ЭВМ, в том числе приспособленных для хранения цифровых файлов (мобильных телефонов, КПК, терминалов, смартфонов и пр.;</p>
<p style="margin-left:24px;">2.1.3. Распространять экземпляры Объектов путем продажи или иного отчуждения экземпляров на Носителях, а также экземпляров/цифровых копий (файлов, содержащих Объекты) в форме Контента, в том числе, способом Цифрового Электронного распространения (стриминг);</p>
<p style="margin-left:24px;">2.1.4. Доводить Объекты до всеобщего сведения таким образом, что любое лицо может получить к ним доступ из любого места и в любое время по собственному выбору, в т.ч. в целях распространения Объектов и Контента, посредством сети Интернет;</p>
<p style="margin-left:24px;margin-top:6px;"><strong>«Механические права»</strong></p>
<p style="margin-left:24px;">2.1.5. Воспроизводить Объекты, то есть изготавливать один и более экземпляров Объектов или их частей на Носителях, а также в любой иной материальной форме. Распространять экземпляры Объектов на Носителях, в том числе продавать или иным образом отчуждать экземпляры Объектов. Сдавать в прокат экземпляры Объектов на Носителях. Импортировать оригиналы или экземпляры Объектов в целях распространения на Носителях;</p>
<p style="margin-left:24px;margin-top:6px;"><strong>«Публичные права»</strong></p>
<p style="margin-left:24px;">2.1.6. Публично показывать Объекты и/или публично исполнять Объекты с помощью технических средств или в живом исполнении в месте, открытом для свободного посещения, или в месте, где присутствует значительное число лиц, не принадлежащих к обычному кругу семьи (насколько это может быть применимо к соответствующему из Объектов);</p>
<p style="margin-left:24px;">2.1.7. Сообщать Объекты в эфир, в том числе через спутник, т.е. сообщать Объекты для всеобщего сведения (включая показ или исполнение) по радио или телевидению, в том числе путем ретрансляции, а также сообщать Объекты по кабелю, т.е. сообщать Объекты для всеобщего сведения по радио или телевидению с помощью кабеля, провода, оптического волокна или аналогичных средств, в том числе путем ретрансляции;</p>
<p style="margin-left:24px;">2.1.8. Получать вознаграждения авторов, исполнителей, за свободное воспроизведение фонограмм и аудиовизуальных произведений в личных целях (статья 1245 ГК РФ), вознаграждение авторов Произведений (с текстом и/или без текста), использованных в аудиовизуальном произведении, при публичном исполнении либо сообщении в эфир или по кабелю такого аудиовизуального произведения (статья 1263 ГК РФ), а также вознаграждение исполнителей за публичное исполнение Фонограммы, опубликованной в коммерческих целях, а также за ее сообщение в эфир или по кабелю, в соответствии со ст.1326 ГК РФ. В этих целях Лицензиат, в том числе, вправе заключать договоры с организациями по управлению правами на коллективной основе.</p>
<p style="margin-left:24px;margin-top:6px;"><strong>«Синхронизация»</strong></p>
<p style="margin-left:24px;">2.1.9. Включать в целях дальнейшего распространения в составные произведения и распространять Объекты в составе альбомов, сборников (составных произведений). Включать Объекты и/или их части в состав любых сложных объектов (в том числе аудиовизуальных произведений), в том числе, создаваемых для рекламы.</p>
<p style="text-indent:24px;margin-top:8px;">2.2. Лицензиар разрешает Лицензиату и его сублицензиатам обнародовать Объекты любыми из перечисленных в настоящем Договоре способами, а также самостоятельно решать указывать или нет имя/псевдоним авторов/исполнителей/изготовителя Фонограмм, в случае, если такое указание невозможно в силу особенностей использования (право на анонимное использование).</p>
<p style="text-indent:24px;">2.3. Лицензиар настоящим даёт Лицензиату согласие на предоставление третьим лицам прав, полученных по Договору (право на сублицензирование).</p>
<p style="text-indent:24px;">2.4. Лицензиат обязуется руководствоваться приоритетом популяризации Объектов и увеличения доходности от использования Объектов при их использовании и выдаче сублицензий на их использование способами, указанными в п. 2.1. Договора.</p>
<p style="text-indent:24px;">2.5. Право использования Объектов, являющееся предметом настоящего Договора, считается предоставленными Лицензиаром Лицензиату с даты подписания Сторонами соответствующего Приложения к Договору, содержащего наименование (название) соответствующего Объекта и/или другие данные о нём.</p>
<p style="text-indent:24px;">2.6. Лицензиар выражает свое согласие со внесением Лицензиатом и иными лицами с разрешения Лицензиата в Объекты изменений, сокращений и дополнений, снабжение их при их использовании иллюстрациями, предисловием, послесловием, комментариями или какими бы то ни было пояснениями.</p>
</div>

<!-- Section 3 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">3. Права и обязанности Сторон</h3>
<p style="font-weight:600;">3.1. Лицензиар обязуется:</p>
<p style="margin-left:24px;">3.1.1. в момент подписания соответствующего Приложения к Договору передать Лицензиату Исходные материалы;</p>
<p style="margin-left:24px;">3.1.2. в течение Срока на Территории не предоставлять третьим лицам право использования Объектов способами, предоставленными Лицензиату по настоящему Договору;</p>
<p style="margin-left:24px;">3.1.3. урегулировать любые претензии обладателей исключительных прав на Объекты, связанные с использованием Объектов, предоставленных по настоящему Договору. В случае если какие-либо третьи лица предъявят к Лицензиату претензии, связанные с выплатой вознаграждения и осуществлением иных платежей, Лицензиар предпримет действия, исключающие возникновение расходов и убытков Лицензиата, связанных с подобными претензиями, и компенсирует такие расходы и убытки в случае, если таковые понесет Лицензиат.</p>
<p style="font-weight:600;margin-top:8px;">3.2. Лицензиар вправе:</p>
<p style="margin-left:24px;">3.2.1. требовать от Лицензиата своевременной выплаты вознаграждения в полном объеме за предоставляемые по настоящему Договору права использования Объектов, согласно правилам предоставления отчетности, согласованным Сторонами в Финансовом соглашении к Договору.</p>
<p style="font-weight:600;margin-top:8px;">3.3. Лицензиат обязуется:</p>
<p style="margin-left:24px;">3.3.1. использовать Объекты исключительно способами на условиях, предусмотренных настоящим Договором;</p>
<p style="margin-left:24px;">3.3.2. выплачивать Лицензиару вознаграждение в размере, порядке и в срок, предусмотренные разделом 4 настоящего Договора;</p>
<p style="margin-left:24px;">3.3.3. предоставлять Лицензиару отчеты об использовании Объектов, в порядке и в сроки, указанные в Финансовом соглашении к Договору;</p>
<p style="font-weight:600;margin-top:8px;">3.4. Лицензиат вправе:</p>
<p style="margin-left:24px;">3.4.1. самостоятельно использовать Объекты способами и на условиях, предусмотренных настоящим Договором;</p>
<p style="margin-left:24px;">3.4.2. предоставлять полученные по настоящему Договору права на все Объекты любым третьим лицам (полностью или частично) путем выдачи сублицензий таким лицам.</p>
<p style="margin-left:24px;">3.4.3. использовать Объекты способами, указанными в п. 2.1. настоящего Договора без ограничения количества воспроизводимых экземпляров указанных Объектов;</p>
<p style="margin-left:24px;">3.4.4. при использовании Объектов (в т.ч. третьими лицами) указывать или размещать свое наименование и/или логотип, а также наименования и логотипы своих партнеров (в том числе сублицензиатов) и спонсоров, а также любую иную информацию, которую Лицензиат сочтет нужной, на всех рекламных материалах Объектов;</p>
<p style="margin-left:24px;">3.4.5. в случаях, когда, указание имен (наименований) правообладателей Объектов и информации об авторском или смежном праве затруднено (в том числе в составе Караоке и Мобильного контента), не указывать полностью или частично такую информацию;</p>
<p style="margin-left:24px;">3.4.6. получать вознаграждение (а также компенсацию) за каждый способ использования Объектов третьими лицами, в том числе, но не ограничиваясь, по выданным Лицензиатом сублицензиям.</p>
</div>

<!-- Section 4 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">4. Вознаграждение Лицензиара</h3>
<p style="text-indent:24px;">4.1. За предоставление права использования Объектов в соответствии с настоящим Договором, Лицензиат обязуется выплачивать Лицензиару вознаграждение за все способы использования Объектов, указанные в Договоре, в размере, в порядке и в сроки, указанные в Финансовом соглашении к настоящему Договору.</p>
<p style="text-indent:24px;">4.2. Все расчеты по настоящему Договору производятся Лицензиатом путем перечисления денежных средств в российских рублях на банковский/расчетный счет Лицензиара, указанный в реквизитах Договора, если иное не указано в Приложениях к Договору.</p>
</div>

<!-- Section 5 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">5. Гарантии Лицензиара</h3>
<p style="text-indent:24px;">5.1. Стороны имеют ясное понимание того, что Лицензиат заключает настоящий Договор, полагаясь на безусловность и истинность следующих гарантий данных Лицензиаром (заверение об обстоятельствах):</p>
<p style="margin-left:24px;">5.1.1. Лицензиар является законным обладателем исключительных прав на Объекты и вправе распоряжаться такими правами;</p>
<p style="margin-left:24px;">5.1.2. на момент подписания настоящего Договора не существует никаких прав, обременений и требований третьих лиц в отношении каждого из Объектов.</p>
<p style="margin-left:24px;">5.1.3. исключительные права на Объекты не находятся в управлении (коллективном или доверительном) согласно указанным в п. 2.1. способам использования (за исключением обществ по коллективному управлению смежными правами), права не заложены, не состоят под арестом и не обременены другим способом;</p>
<p style="margin-left:24px;">5.1.4. заключение настоящего Договора и предоставление права использования Объектов, не нарушают законных прав третьих лиц;</p>
<p style="margin-left:24px;">5.1.5. Лицензиар гарантирует, что не выдавал третьим лицам исключительных лицензий предоставляющих право использования Объектов в пределах и способами, установленными Договором к моменту подписания соответствующего Приложения к Договору, а в случае если такие лицензии в отношении указанных Объектов были выданы Лицензиаром третьим лицам, то срок их действия истек или иным образом их действие прекращено к моменту заключения настоящего Договора.</p>
</div>

<!-- Section 6 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">6. Ответственность Сторон</h3>
<p style="text-indent:24px;">6.1. За неисполнение или ненадлежащее исполнение обязательств по Договору Стороны несут ответственность в соответствии с действующим законодательством Российской Федерации и Договором. В случае возникновения разногласий между Сторонами по поводу исполнения, действительности или толкования Договора, Стороны будут стараться разрешить такое разногласие путем переговоров. Если в течение 30 (тридцати) календарных дней с момента заявления Стороной другой Стороне об имеющем место разногласии такое разногласие не урегулировано или урегулировано не полностью, спор подлежит разрешению в Арбитражном суде г. Москвы (договорная подсудность).</p>
<p style="text-indent:24px;">6.2. Приложениями, дополнительными соглашениями к настоящему Договору могут быть предусмотрены дополнительные меры ответственности, применяемые к Сторонам, которые нарушают / ненадлежащим образом выполняют свои обязательства, нарушают гарантии по Договору.</p>
<p style="text-indent:24px;">6.3. Применимое право по настоящему Договору – законодательство Российской Федерации.</p>
</div>

<!-- Section 7 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">7. Срок действия Договора</h3>
<p style="text-indent:24px;">7.1. Договор вступает в силу с момента его подписания Сторонами и действует до полного исполнения Сторонами своих обязательств по Договору и Приложениям к нему. Право использования Объектов действует в течение Срока. Срок действия настоящего Договора считается автоматически продленным на каждый последующий календарный год на тех же условиях при условии отсутствия уведомления об ином, направленного одной Стороной в адрес другой Стороны заказным письмом не менее чем за 90 (девяносто) рабочих дней до истечения срока действия настоящего Договора.</p>
<p style="text-indent:24px;">7.2. Настоящий Договор может быть расторгнут Лицензиатом досрочно в одностороннем порядке в случаях, предусмотренных действующим законодательством РФ и настоящим Договором.</p>
</div>

<!-- Section 8 -->
<div>
<h3 style="font-size:13px;font-weight:700;margin-bottom:6px;">8. Заключительные положения</h3>
<p style="text-indent:24px;">8.1. Условия настоящего Договора, а также иная информация и документы, предоставляемые Сторонами друг другу в ходе исполнения Договора, являются конфиденциальной информацией и не подлежат разглашению третьим лицам. Настоящее положение не применяется, если раскрытие такой информации:</p>
<p style="margin-left:24px;">- необходимо для исполнения обязательств по настоящему Договору и/или реализации (использования) прав, полученных по настоящему Договору;</p>
<p style="margin-left:24px;">- требуется в соответствии с положениями законодательства РФ;</p>
<p style="margin-left:24px;">- получено предварительное письменное согласие другой Стороны.</p>
<p style="text-indent:24px;">8.2. Слова, указанные во множественном числе, означают также единственное число и, наоборот, в зависимости от контекста.</p>
<p style="text-indent:24px;">8.3. В случае если какое-либо из положений настоящего Договора окажется ничтожным или будет признано недействительным в соответствии с законодательством РФ, остальные положения останутся в силе, Договор будет исполняться Сторонами в полном объеме без учета такого положения.</p>
<p style="text-indent:24px;">8.4. Перемена Стороны настоящего Договора осуществляется только на основании предварительного письменного согласия второй Стороны.</p>
<p style="text-indent:24px;">8.5. Все изменения и дополнения к настоящему Договору действительны, если они должным образом подписаны уполномоченными представителями Сторон.</p>
<p style="text-indent:24px;">8.6. Стороны должны сообщать друг другу об изменении своих адресов места нахождения, банковских реквизитов, в противном случае действуют реквизиты, указанные в Договоре. Все заявления, извещения, уведомления и/или требования по настоящему Договору должны быть совершены в письменном виде и непосредственно вручены под расписку. Предварительно соответствующие документы могут быть направлены электронным или факсимильным сообщением. В исключительном случае (при невозможности личного вручения) соответствующий документ может быть направлен Стороне почтой ценным письмом с описью вложения.</p>
<p style="text-indent:24px;">8.7. Стороны признают юридическую силу документов, направленных друг другу посредством использования информационно-телекоммуникационной сети, а именно: в мессенджерах, социальных сетях, а также по адресу электронной почты, которые указаны в п. 9 Договора.</p>
<p style="text-indent:24px;">8.8. В удостоверение своего согласия с вышеизложенными условиями Стороны заключили настоящий Договор в день, указанный на первой странице Договора, в двух оригинальных экземплярах, имеющих одинаковую юридическую силу, по одному для каждой из Сторон.</p>
</div>

<!-- 9. Реквизиты и подписи -->
<div style="margin-top:20px;border-top:2px solid #000;padding-top:12px;">
<h3 style="font-size:13px;font-weight:700;text-align:center;margin-bottom:8px;">9. Адреса, реквизиты и подписи Сторон</h3>
<table style="width:100%;border:none;"><tr style="border:none;">
<td style="border:1px solid #000;padding:10px;width:50%;vertical-align:top;">
  <h4 style="font-weight:700;text-align:center;margin-bottom:8px;">Лицензиар</h4>
  <p>Гражданин ${countryShort} <strong>${data.fullName}</strong></p>
  <p>Паспорт: ${data.passport}</p>
  <p>Выдан: ${data.passportIssuedBy}</p>
  <p>Код подразделения: ${data.passportCode}</p>
  <p>Дата выдачи: ${data.passportDate}</p>
  <p>E-mail: ${data.email}</p>
  ${data.bankAccount ? `<p style="font-weight:600;margin-top:6px;">Банковские реквизиты:</p><p>Номер счета: ${data.bankAccount}</p><p>БИК: ${data.bankBik||''}</p>${data.bankCorr ? `<p>Корр. счет: ${data.bankCorr}</p>` : ''}` : ''}
  ${data.cardNumber ? `<p>Номер карты: ${data.cardNumber}</p>` : ''}
  <div style="margin-top:12px;padding-top:8px;border-top:1px dashed #000;text-align:center;">
    ${signatureDataUrl ? `<img src="${signatureDataUrl}" style="height:40px;object-fit:contain;" /><br/><em style="font-size:10px;">/${data.fullName}/</em>` : `<em>/${data.fullName}/</em>`}
  </div>
</td>
<td style="border:1px solid #000;padding:10px;width:50%;vertical-align:top;">
  <h4 style="font-weight:700;text-align:center;margin-bottom:8px;">Лицензиат</h4>
  <p>Гражданин Российской Федерации</p>
  <p><strong>Плотников Никита Владимирович</strong></p>
  <p style="font-size:10px;opacity:0.8;">физическое лицо, применяющее специальный налоговый режим «НПД»</p>
  <p>Дата рождения: 23.06.2004</p>
  <p>Адрес регистрации: г. Шахты, пер. Дундича д.14</p>
  <p>Серия и номер паспорта: 6024 816315</p>
  <p>Кем выдан: ГУ МВД РОССИИ ПО РОСТОВСКОЙ ОБЛАСТИ</p>
  <p>Дата выдачи: 24.07.2024</p>
  <p>Код подразделения: 610-009</p>
  <p>ИНН: 615531925831</p>
  <p>Email: thqlabel@ya.ru</p>
  <p>Телефон: +79515352287</p>
  <p style="font-weight:600;margin-top:6px;">Реквизиты:</p>
  <p>БИК: 044525593</p>
  <p>Номер счёта: 40817810705892387715</p>
  <div style="margin-top:12px;padding-top:8px;border-top:1px dashed #000;text-align:center;">
    ${plotSig ? `<img src="${plotSig}" style="height:40px;object-fit:contain;" /><br/>` : ''}<em style="font-size:10px;">/Плотников Никита Владимирович/</em>
  </div>
</td>
</tr></table>
</div>

<!-- Приложение 1 — Финансовое соглашение -->
<div style="margin-top:30px;border-top:2px solid #000;padding-top:12px;page-break-before:always;">
<h3 style="font-size:14px;font-weight:700;text-align:center;margin-bottom:4px;">Приложение № 1 к Лицензионному договору № ${contractNumber} от ${dateStr}</h3>
<h4 style="font-weight:700;font-size:13px;text-align:center;margin-bottom:8px;">Финансовое соглашение</h4>
<div style="display:flex;justify-content:space-between;margin-top:4px;"><span>г. Ростов-на-Дону</span><span>${dateStr}</span></div>

<p style="text-indent:24px;margin:10px 0;">Гражданин ${countryShort} <strong>${data.fullName}</strong>, действующий от своего имени и в своем интересе, именуемый в дальнейшем «Лицензиар», с одной стороны, и</p>
<p style="text-indent:24px;margin:10px 0;">Гражданин Российской Федерации <strong>Плотников Никита Владимирович</strong>, физическое лицо, применяющее специальный налоговый режим «Налог на профессиональный доход (НПД)», именуемый в дальнейшем «Лицензиат», с другой стороны, именуемые совместно – «Стороны», а по отдельности «Сторона», действуя на основании Договора, составили и подписали настоящее Финансовое соглашение (далее – «Соглашение») о нижеследующем:</p>

<h4 style="font-weight:700;font-size:12px;margin-top:12px;">Терминология, используемая в Соглашении:</h4>
<p style="text-indent:24px;"><strong>«Цифровая дистрибуция»</strong> - использование Лицензиатом (в том числе сублицензиатами и третьими лицами) Объектов способами, указанными в п. 2.1.1.-2.1.4. Договора;</p>
<p style="text-indent:24px;"><strong>«Механические права»</strong> - использование Лицензиатом (в том числе сублицензиатами и третьими лицами) Объектов способами, указанными в п. 2.1.5. Договора;</p>
<p style="text-indent:24px;"><strong>«Публичные права»</strong> - использование Лицензиатом (в том числе сублицензиатами, третьими лицами и организациями по коллективному управлению правами) Объектов способами, указанными в п. 2.1.6.-2.1.8. Договора;</p>
<p style="text-indent:24px;"><strong>«Синхронизация»</strong> - использование Лицензиатом (в том числе сублицензиатами и третьими лицами) Объектов способами, указанными в п. 2.1.9. Договора.</p>
<p style="text-indent:24px;"><strong>«Доход Лицензиата»</strong> - сумма финансовых поступлений (выручки) за вычетом применимых налогов, фактически полученная Лицензиатом (в том числе от сублицензиатов и третьих лиц) от использования Объектов и любых иных результатов интеллектуальной деятельности, создаваемых с использованием Объектов, путём Цифровой дистрибуции, Механических прав, Публичных прав и Синхронизации.</p>
<p style="text-indent:24px;"><strong>«Отчётный период»</strong> - календарный квартал года. Под календарным кварталом Стороны понимают период времени из 3 (трех) календарных месяцев, отсчет которых ведется от первого числа календарного года;</p>
<p style="text-indent:24px;"><strong>«Отчёт»</strong> - печатный и/или электронный документ, содержащий информацию о размере вознаграждения (Роялти) Лицензиара, подлежащего выплате за Отчетный период.</p>

<p style="text-indent:24px;margin-top:12px;">1. Стороны пришли к соглашению, что, если иное не предусмотрено соответствующим Приложением к Договору, то за предоставленные Лицензиаром Лицензиату по Договору права использования Объектов, указанных в Приложениях к Договору, Лицензиат обязуется выплачивать Лицензиару вознаграждение в виде процента от Дохода Лицензиата в размере, в порядке и в сроки, указанные в настоящем Соглашении.</p>

<p style="text-indent:24px;margin-top:8px;">2. Лицензиат выплачивает Лицензиару Роялти в следующем размере:</p>

<table style="width:100%;border-collapse:collapse;margin:10px 0;">
<tr><th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;font-weight:600;">Способы использования</th><th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;text-align:center;">Роялти от Дохода Лицензиата при реализации авторских прав (Произведений)</th><th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;text-align:center;">Роялти от Дохода Лицензиата при реализации смежных прав (Исполнений и Фонограмм)</th></tr>
${['Цифровая дистрибуция','Механические права','Публичные права','Синхронизация'].map(s=>`<tr><td style="border:1px solid #000;padding:4px 6px;">${s}</td><td style="border:1px solid #000;padding:4px 6px;text-align:center;font-weight:700;">80%</td><td style="border:1px solid #000;padding:4px 6px;text-align:center;font-weight:700;">80%</td></tr>`).join('')}
</table>

<p style="text-indent:24px;margin-top:8px;">3. Отчёты предоставляются Лицензиатом Лицензиару в следующем порядке и сроки:</p>
<p style="text-indent:24px;">3.1. Не позднее 45 (сорока пяти) календарных дней после окончания очередного Отчетного периода, Лицензиат направляет Лицензиару на электронный адрес, указанный в реквизитах Договора, печатный (в виде сканированной копии) и/или электронный документ в виде файла формата excel, word, pdf или в ином другом формате, позволяющем целостно и точно воспринимать передаваемую информацию, содержащий Отчет.</p>
<p style="text-indent:24px;">3.2. В течение 5 (пяти) календарных дней с даты получения Отчета, Лицензиар рассматривает его и направляет на адрес электронной почты Лицензиата, указанный в реквизитах Договора, подписанный Отчет в виде сканированной копии, либо мотивированный отказ от принятия Отчета в виде претензии с обоснованием причины в письменной форме. В случае отсутствия сканированной копии согласованного Отчета или претензии Лицензиара, по истечении вышеуказанного срока, Отчет считается принятым Лицензиаром.</p>
<p style="text-indent:24px;">3.3. При этом Стороны Договорились, что Лицензиар может выразить согласие с Отчетом и в иной форме, без подписания и направления Лицензиату подписанной сканированной копии. В том числе путем согласования в переписке с адреса электронной почты или в мессенджере, которые указаны в реквизитах Договора.</p>

<p style="text-indent:24px;margin-top:8px;">4. Вознаграждение Лицензиара выплачивается в следующем порядке и сроки:</p>
<p style="text-indent:24px;">4.1. В срок не позднее 5 (пяти) календарных дней, с момента получения Лицензиатом от Лицензиара подписанного Отчета в соответствии с п. 3.2. Соглашения, Лицензиат выплачивает Лицензиару все суммы вознаграждения, причитающиеся к выплате Лицензиару на основании Отчётов.</p>
<p style="text-indent:24px;">4.2. Стороны подтверждают, что выплата вознаграждения будет производиться с учетом фактических расходов Лицензиата по выплате вознаграждения третьим лицам - соавторам (соисполнителям) Объектов.</p>

<p style="text-indent:24px;margin-top:8px;">5. Стороны согласились, что отчетность и документация, заверенная печатями и подписями уполномоченных представителей Сторон, направленная по адресу электронной почты, в соответствии с положениями настоящего Соглашения, обладает той же юридической силой, как если бы данная отчетность и документация была направлена Сторонами на бумажном носителе.</p>
<p style="text-indent:24px;">6. Настоящее Соглашение вступает в силу с даты его подписания Сторонами и действует в течение срока действия Договора.</p>
<p style="text-indent:24px;">7. Настоящее Соглашение является неотъемлемой частью Договора, составлено в 2 (двух) идентичных экземплярах, имеющих одинаковую юридическую силу, по одному для каждой Стороны.</p>
<p style="text-indent:24px;margin-top:8px;font-weight:600;">8. Подписи Сторон</p>

${sigBlock()}
</div>

<!-- Приложение 2 — Список объектов -->
<div style="margin-top:30px;border-top:2px solid #000;padding-top:12px;page-break-before:always;">
<h3 style="font-size:14px;font-weight:700;text-align:center;margin-bottom:4px;">Приложение № 2 к Лицензионному договору № ${contractNumber} от ${dateStr}</h3>
<div style="display:flex;justify-content:space-between;margin-top:4px;"><span>г. Ростов-на-Дону</span><span>${dateStr}</span></div>

<p style="text-indent:24px;margin:10px 0;">Гражданин ${countryShort} <strong>${data.fullName}</strong>, действующий от своего имени и в своем интересе, именуемый в дальнейшем «Лицензиар», с одной стороны, и</p>
<p style="text-indent:24px;margin:10px 0;">Гражданин Российской Федерации <strong>Плотников Никита Владимирович</strong>, физическое лицо, применяющее специальный налоговый режим «Налог на профессиональный доход (НПД)», именуемый в дальнейшем «Лицензиат», с другой стороны, именуемые совместно – «Стороны», а по отдельности «Сторона», действуя на основании Договора, составили и подписали настоящее приложение к Договору (далее – «Приложение») о нижеследующем:</p>

<p style="text-indent:24px;margin-top:8px;">1. Лицензиар предоставляет Лицензиату на Территорию и на Срок, право использование следующих Объектов:</p>

<table style="width:100%;border-collapse:collapse;margin:10px 0;font-size:10px;">
<tr>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;text-align:center;width:25px;">№</th>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;">Название Произведения</th>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;text-align:center;">Длительность</th>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;">Автор музыки</th>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;">Автор слов</th>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;">Исполнители</th>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;">Изготовитель Фонограммы</th>
  <th style="border:1px solid #000;padding:4px;background:#f0f0f0;text-align:center;">Срок лицензии</th>
</tr>
${trackRows}
</table>

<p style="text-indent:24px;margin-top:8px;">2. Настоящим Лицензиат подтверждает, что получил Исходный материал, содержащий профессиональную запись копий вышеуказанного Объекта надлежащего технического качества и эталонного (оригинального) звучания, посредством Интернет-передачи через FTP-протокол.</p>
<p style="text-indent:24px;">3. Настоящее Приложение вступает в силу с даты, указанной в преамбуле (дата подписания), и действует в течение Срока. Во всем, что не предусмотрено настоящим Приложением, Стороны руководствуются условиями Договора. Срок лицензии настоящего приложения считается автоматически продленным на каждый последующий календарный год на тех же условиях при условии отсутствия уведомления об ином, направленного одной Стороной в адрес другой Стороны заказным письмом не менее чем за 90 (девяносто) рабочих дней до истечения срока лицензии объектов настоящего приложения.</p>
<p style="text-indent:24px;">4. Настоящее Приложение является неотъемлемой частью Договора, составлено в 2 (двух) экземплярах одинаковой юридической силы – по одному для каждой из Сторон.</p>
<p style="text-indent:24px;margin-top:8px;font-weight:600;">5. Подписи Сторон</p>

${sigBlock()}
</div>

<!-- Приложение 3 — Форма отчёта -->
<div style="margin-top:30px;border-top:2px solid #000;padding-top:12px;page-break-before:always;">
<h3 style="font-size:14px;font-weight:700;text-align:center;margin-bottom:8px;">Приложение № 3 к Лицензионному договору № ${contractNumber} от ${dateStr}</h3>

<p style="text-indent:24px;margin:10px 0;">Гражданин ${countryShort} <strong>${data.fullName}</strong>, действующий от своего имени и в своем интересе, именуемый в дальнейшем «Лицензиар», с одной стороны, и</p>
<p style="text-indent:24px;margin:10px 0;">Гражданин Российской Федерации <strong>Плотников Никита Владимирович</strong>, физическое лицо, применяющее специальный налоговый режим «Налог на профессиональный доход (НПД)», именуемый в дальнейшем «Лицензиат», с другой стороны, именуемые совместно – «Стороны», а по отдельности «Сторона», действуя на основании Договора, составили и подписали настоящее приложение к Договору (далее – «Приложение») о нижеследующем:</p>

<h4 style="font-weight:700;font-size:13px;text-align:center;margin-top:16px;">ФОРМА ОТЧЁТА</h4>
<p style="margin:12px 0;text-align:center;">Отчёт об использовании Объектов<br/>за период с «____» ____________ 20___ г. по «____» ____________ 20___ г.</p>

<table style="width:100%;border-collapse:collapse;margin:10px 0;">
<tr>
  <th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;text-align:center;width:30px;">№ п/п</th>
  <th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;">Название</th>
  <th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;">Автор музыки</th>
  <th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;">Автор текста</th>
  <th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;">Исполнитель</th>
  <th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;text-align:center;">Доход Лицензиата</th>
  <th style="border:1px solid #000;padding:4px 6px;background:#f0f0f0;text-align:center;">Вознаграждение Лицензиара</th>
</tr>
<tr><td colspan="7" style="border:1px solid #000;padding:12px;text-align:center;font-style:italic;opacity:0.6;height:60px;"></td></tr>
<tr><td colspan="7" style="border:1px solid #000;padding:12px;text-align:center;font-style:italic;opacity:0.6;height:60px;"></td></tr>
<tr><td colspan="7" style="border:1px solid #000;padding:12px;text-align:center;font-style:italic;opacity:0.6;height:60px;"></td></tr>
</table>

<p style="margin-top:12px;"><strong>Вознаграждение Лицензиара за период составляет:</strong> ________________________</p>

${sigBlock()}
</div>

</div>`;
}

/**
 * Wraps contract HTML in a Word-compatible document and triggers download
 */
export function downloadContractAsDoc(htmlBody: string, fileName: string): void {
  const fullHtml = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8">
<!--[if gte mso 9]><xml><w:WordDocument><w:View>Print</w:View></w:WordDocument></xml><![endif]-->
<style>
  @page { size: A4; margin: 2cm; }
  body { font-family: 'Times New Roman', serif; font-size: 12pt; color: #000000; line-height: 1.6; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #000000; padding: 4px 6px; font-size: 11pt; }
  th { background-color: #f0f0f0; font-weight: bold; }
  h2, h3, h4 { font-weight: bold; color: #000000; }
  p { margin: 4px 0; }
  img { max-height: 40px; }
</style>
</head>
<body>${htmlBody}</body>
</html>`;

  const blob = new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function waitForImagesInElement(root: HTMLElement, timeoutMs = 5000): Promise<void> {
  const images = Array.from(root.querySelectorAll('img')) as HTMLImageElement[];
  if (images.length === 0) return;

  await Promise.all(
    images.map((img) => new Promise<void>((resolve) => {
      if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
        resolve();
        return;
      }

      let settled = false;
      const done = () => {
        if (settled) return;
        settled = true;
        img.removeEventListener('load', onDone);
        img.removeEventListener('error', onDone);
        clearTimeout(timer);
        resolve();
      };

      const onDone = () => done();
      const timer = window.setTimeout(done, timeoutMs);

      img.addEventListener('load', onDone, { once: true });
      img.addEventListener('error', onDone, { once: true });
    }))
  );
}

/**
 * Convert an image URL to base64 data URL
 */
async function imageUrlToBase64(url: string): Promise<string> {
  try {
    // If already a data URL, return as-is
    if (url.startsWith('data:')) return url;
    
    const response = await fetch(url);
    const blob = await response.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result as string);
      reader.onerror = () => resolve(url); // fallback to original
      reader.readAsDataURL(blob);
    });
  } catch {
    return url; // fallback to original
  }
}

/**
 * Convert all img tags in container from relative URLs to base64
 */
async function convertImagesToBase64(container: HTMLElement): Promise<void> {
  const images = Array.from(container.querySelectorAll('img')) as HTMLImageElement[];
  await Promise.all(images.map(async (img) => {
    const src = img.getAttribute('src') || '';
    if (src && !src.startsWith('data:')) {
      const base64 = await imageUrlToBase64(src);
      img.setAttribute('src', base64);
    }
  }));
}

/**
 * Renders contract HTML into a hidden container, captures the ENTIRE contract as one canvas,
 * then slices it into A4 pages with smart page breaks to avoid cutting through text/content.
 */
export async function downloadContractAsPdf(htmlBody: string, fileName: string): Promise<void> {
  const html2canvas = (await import('html2canvas-pro')).default;
  const { jsPDF } = await import('jspdf');

  // Create off-screen container with contract content
  const container = document.createElement('div');
  container.style.cssText = 'position:fixed;left:-9999px;top:0;width:794px;background:#fff;padding:56px 56px 56px 56px;font-family:"Times New Roman",Georgia,serif;font-size:12px;line-height:1.6;color:#000;';
  container.innerHTML = htmlBody;
  document.body.appendChild(container);

  // Convert all images to base64 FIRST (solves CORS/taint issues)
  await convertImagesToBase64(container);

  // Wait for ALL images (signatures) to fully load before capture
  await waitForImagesInElement(container);

  // Extra delay for rendering
  await new Promise(r => setTimeout(r, 500));

  try {
    const pdfW = 210; // A4 width in mm
    const pdfH = 297; // A4 height in mm
    const marginTop = 15;
    const marginBottom = 15;
    const marginLR = 15;
    const contentW = pdfW - marginLR * 2;
    const contentH = pdfH - marginTop - marginBottom;

    // Render the ENTIRE contract as a single canvas
    const fullCanvas = await html2canvas(container, {
      scale: 2.5, // Slightly lower scale for better performance
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      logging: false,
      windowWidth: 794,
      scrollY: 0,
      scrollX: 0,
      height: container.scrollHeight,
      onclone: (_doc: Document, clonedEl: HTMLElement) => {
        clonedEl.style.backgroundColor = '#ffffff';
        clonedEl.style.overflow = 'visible';
        clonedEl.style.height = 'auto';
        const ci = clonedEl.querySelectorAll('img');
        ci.forEach(i => {
          (i as HTMLElement).style.filter = 'none';
          (i as HTMLElement).style.opacity = '1';
          (i as HTMLElement).style.visibility = 'visible';
        });
      },
    });

    const imgW = fullCanvas.width;
    const imgH = fullCanvas.height;
    const ratio = contentW / imgW; // mm per pixel
    const pagePixelH = contentH / ratio; // how many pixels fit on one page

    // Helper: check if a horizontal line at y is mostly white (good break point)
    const isRowWhite = (y: number, threshold = 248): boolean => {
      const ctx = fullCanvas.getContext('2d');
      if (!ctx || y < 0 || y >= fullCanvas.height) return false;
      const step = Math.max(1, Math.floor(fullCanvas.width / 100));
      const data = ctx.getImageData(0, Math.floor(y), fullCanvas.width, 1).data;
      let whiteCount = 0;
      let total = 0;
      for (let x = 0; x < fullCanvas.width; x += step) {
        const idx = x * 4;
        const r = data[idx], g = data[idx + 1], b = data[idx + 2];
        if (r >= threshold && g >= threshold && b >= threshold) whiteCount++;
        total++;
      }
      return total > 0 && (whiteCount / total) > 0.92;
    };

    // Check if a band of rows (y to y+bandHeight) is all white - indicating a paragraph gap
    const isWhiteBand = (startY: number, bandHeight: number): boolean => {
      for (let dy = 0; dy < bandHeight; dy++) {
        if (!isRowWhite(startY + dy)) return false;
      }
      return true;
    };

    // Find the best break point near targetY by searching for white bands
    const findBreakPoint = (targetY: number, searchRange: number): number => {
      const minBandHeight = 8; // Minimum consecutive white rows to be considered a paragraph gap
      
      // Search backwards from target (prefer earlier breaks)
      for (let offset = 0; offset <= searchRange; offset++) {
        const y = Math.floor(targetY - offset);
        if (y <= minBandHeight) return targetY;
        if (isWhiteBand(y - minBandHeight / 2, minBandHeight)) {
          return y;
        }
      }
      
      // If no good break found backwards, search a little forward
      for (let offset = 1; offset <= Math.floor(searchRange * 0.5); offset++) {
        const y = Math.floor(targetY + offset);
        if (y >= imgH - minBandHeight) return targetY;
        if (isWhiteBand(y - minBandHeight / 2, minBandHeight)) {
          return y;
        }
      }

      // Last resort: find ANY single white row
      for (let offset = 0; offset <= searchRange * 1.5; offset++) {
        const y = Math.floor(targetY - offset);
        if (y <= 0) break;
        if (isRowWhite(y) && isRowWhite(y - 1)) {
          return y;
        }
      }
      
      return targetY;
    };

    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', compress: true });
    const searchRange = Math.floor(pagePixelH * 0.25); // Search 25% of page height for breaks

    let srcY = 0;
    let pageIndex = 0;

    while (srcY < imgH) {
      if (pageIndex > 0) pdf.addPage();

      let nextBreak: number;
      if (srcY + pagePixelH >= imgH) {
        // Last page - take everything remaining
        nextBreak = imgH;
      } else {
        nextBreak = findBreakPoint(srcY + pagePixelH, searchRange);
      }

      const sliceH = Math.max(1, nextBreak - srcY);
      const sliceMm = sliceH * ratio;

      const pageCanvas = document.createElement('canvas');
      pageCanvas.width = imgW;
      pageCanvas.height = Math.ceil(sliceH);
      const ctx = pageCanvas.getContext('2d');
      if (ctx) {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);
        ctx.drawImage(fullCanvas, 0, srcY, imgW, sliceH, 0, 0, imgW, sliceH);
        pdf.addImage(pageCanvas.toDataURL('image/jpeg', 0.92), 'JPEG', marginLR, marginTop, contentW, sliceMm);
      }

      srcY = nextBreak;
      pageIndex++;
      
      // Safety: prevent infinite loop
      if (pageIndex > 50) break;
    }

    pdf.save(fileName);
  } finally {
    document.body.removeChild(container);
  }
}
