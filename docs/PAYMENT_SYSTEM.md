# üí≥ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ THQ Label

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –†–µ–≥–∏–æ–Ω | –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã | –ú–∏–Ω. —Å—É–º–º–∞ |
|-----------|--------|---------------|------------|
| **YooKassa** | –†–æ—Å—Å–∏—è üá∑üá∫ | –°–ë–ü, Visa/MC/–ú–ò–†, –ÆMoney | 100 ‚ÇΩ |
| **Stripe** | –í–µ—Å—å –º–∏—Ä üåç | Visa/MC/AMEX | $5 |
| **LiqPay** | –£–∫—Ä–∞–∏–Ω–∞ üá∫üá¶ | –ü—Ä–∏–≤–∞—Ç–ë–∞–Ω–∫, –∫–∞—Ä—Ç—ã | 50 ‚Ç¥ |
| **CryptoCloud** | –ê–Ω–æ–Ω–∏–º–Ω–æ üîê | BTC, ETH, USDT, TON | 500 ‚ÇΩ |

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

```sql
-- –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ Supabase SQL Editor
-- –§–∞–π–ª: sql/balance_system.sql
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# .env.local

# YooKassa (–†–æ—Å—Å–∏—è)
YOOKASSA_SHOP_ID=512746
YOOKASSA_SECRET_KEY=test_...
YOOKASSA_TEST_MODE=true

# Stripe (–ú–∏—Ä)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...

# LiqPay (–£–∫—Ä–∞–∏–Ω–∞)
LIQPAY_PUBLIC_KEY=sandbox_...
LIQPAY_PRIVATE_KEY=sandbox_...

# CryptoCloud (–ö—Ä–∏–ø—Ç–∞)
CRYPTOCLOUD_SHOP_ID=...
CRYPTOCLOUD_API_KEY=...

# URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
NEXT_PUBLIC_APP_URL=https://your-domain.com
```

### 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Webhook'–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–∞—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### YooKassa (–†–æ—Å—Å–∏—è)

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è: https://yookassa.ru/
2. –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω
3. –ü–æ–ª—É—á–∏—Ç—å `shopId` –∏ `secretKey`
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook:
   - URL: `https://your-domain.com/api/payments/webhook/yookassa`
   - –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

**–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:**
- –£—Å–ø–µ—Ö: `5555 5555 5555 4444`
- –û—Ç–∫–∞–∑: `5555 5555 5555 4002`

### Stripe (–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ)

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è: https://stripe.com/
2. –ü–æ–ª—É—á–∏—Ç—å API –∫–ª—é—á–∏ –≤ Dashboard > Developers
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook:
   - URL: `https://your-domain.com/api/payments/webhook/stripe`
   - –°–æ–±—ã—Ç–∏—è: `checkout.session.completed`, `payment_intent.payment_failed`

**–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:**
- –£—Å–ø–µ—Ö: `4242 4242 4242 4242`
- –û—Ç–∫–∞–∑: `4000 0000 0000 0002`

### LiqPay (–£–∫—Ä–∞–∏–Ω–∞)

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è: https://www.liqpay.ua/
2. –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω –≤ –∫–∞–±–∏–Ω–µ—Ç–µ
3. –ü–æ–ª—É—á–∏—Ç—å `public_key` –∏ `private_key`
4. Webhook –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API

**–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sandbox_ –∫–ª—é—á–∏
- –ö–∞—Ä—Ç–∞: –ª—é–±–∞—è —Å CVV 111

### CryptoCloud (–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã)

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è: https://cryptocloud.plus/
2. –°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω
3. –ü–æ–ª—É—á–∏—Ç—å `shop_id` –∏ `api_key`
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook:
   - URL: `https://your-domain.com/api/payments/webhook/cryptocloud`

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
app/
‚îú‚îÄ‚îÄ api/payments/
‚îÇ   ‚îú‚îÄ‚îÄ create/route.ts          # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
‚îÇ   ‚îî‚îÄ‚îÄ webhook/
‚îÇ       ‚îú‚îÄ‚îÄ yookassa/route.ts    # Webhook YooKassa
‚îÇ       ‚îú‚îÄ‚îÄ stripe/route.ts      # Webhook Stripe
‚îÇ       ‚îú‚îÄ‚îÄ liqpay/route.ts      # Webhook LiqPay
‚îÇ       ‚îî‚îÄ‚îÄ cryptocloud/route.ts # Webhook CryptoCloud
‚îú‚îÄ‚îÄ cabinet/
‚îÇ   ‚îú‚îÄ‚îÄ balance/page.tsx         # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±–∞–ª–∞–Ω—Å–∞
‚îÇ   ‚îî‚îÄ‚îÄ components/finance/
‚îÇ       ‚îú‚îÄ‚îÄ BalanceCard.tsx      # –ö–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞
‚îÇ       ‚îú‚îÄ‚îÄ DepositModal.tsx     # –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
‚îÇ       ‚îú‚îÄ‚îÄ FinanceTab.tsx       # –í–∫–ª–∞–¥–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤
‚îÇ       ‚îî‚îÄ‚îÄ ...
sql/
‚îî‚îÄ‚îÄ balance_system.sql           # –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
```

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å—É–º–º—É –∏ –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã
   ‚îî‚îÄ> POST /api/payments/create

2. –°–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–∫–∞–∑ –≤ –ë–î (payment_orders)
   ‚îî‚îÄ> status: 'pending'

3. –°–æ–∑–¥–∞—ë—Ç—Å—è –ø–ª–∞—Ç—ë–∂ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
   ‚îî‚îÄ> status: 'waiting'

4. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä —à–ª—ë—Ç webhook
   ‚îî‚îÄ> POST /api/payments/webhook/{provider}

6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞
   ‚îî‚îÄ> –ï—Å–ª–∏ —É—Å–ø–µ—Ö: –≤—ã–∑–æ–≤ deposit_balance()

7. –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–∞ –±–∞–ª–∞–Ω—Å
   ‚îî‚îÄ> –ó–∞–ø–∏—Å—å –≤ transactions
   ‚îî‚îÄ> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ user_balances
```

---

## üóÉÔ∏è –¢–∞–±–ª–∏—Ü—ã –ë–î

### user_balances
```sql
- user_id (PK, FK -> auth.users)
- balance (DECIMAL) - —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
- frozen_balance - –∑–∞–º–æ—Ä–æ–∂–µ–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞
- total_deposited - –≤—Å–µ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–æ
- total_withdrawn - –≤—Å–µ–≥–æ –≤—ã–≤–µ–¥–µ–Ω–æ
```

### transactions
```sql
- id (UUID PK)
- user_id (FK)
- type: 'deposit' | 'withdrawal' | 'royalty' | 'purchase'
- amount (DECIMAL)
- description
- metadata (JSONB)
- created_at
```

### payment_orders
```sql
- id (UUID PK)
- user_id (FK)
- amount, currency
- provider: 'yookassa' | 'stripe' | 'liqpay' | 'cryptocloud'
- status: 'pending' | 'waiting' | 'completed' | 'failed'
- provider_order_id
- expires_at
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ

### –ò—Å–ø–æ–ª—å–∑—É—è ngrok:
```bash
ngrok http 3000
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
```

### –ò—Å–ø–æ–ª—å–∑—É—è localtunnel:
```bash
npx localtunnel --port 3000
# –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–≤–µ—Å—Ç–∏ —Å–≤–æ–π –≤–Ω–µ—à–Ω–∏–π IP –∫–∞–∫ –ø–∞—Ä–æ–ª—å
```

---

## üí° –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç

–ü—Ä–∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Ä—É–±–ª–∏:

- **USD ‚Üí RUB**: –∫—É—Ä—Å ~90 (–æ–±–Ω–æ–≤–ª—è—Ç—å!)
- **UAH ‚Üí RUB**: –∫—É—Ä—Å ~2.4 (–æ–±–Ω–æ–≤–ª—è—Ç—å!)
- **Crypto**: CryptoCloud —Å–∞–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç

> ‚ö†Ô∏è –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¶–ë –†–§)

---

## ‚ùì FAQ

**Q: –ü–æ—á–µ–º—É –ø–ª–∞—Ç—ë–∂ –Ω–µ –∑–∞—á–∏—Å–ª—è–µ—Ç—Å—è?**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook URL –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Vercel/–∫–æ–Ω—Å–æ–ª–∏
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã –ë–î —Å–æ–∑–¥–∞–Ω—ã

**Q: –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –¥–µ–ø–ª–æ—è?**
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –∏–ª–∏ localtunnel –¥–ª—è –ø—Ä–æ–±—Ä–æ—Å–∞ localhost

**Q: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞?**
- YooKassa: 100 ‚ÇΩ
- Stripe: $5
- LiqPay: 50 ‚Ç¥
- CryptoCloud: 500 ‚ÇΩ

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ webhook'–æ–≤ –≤ –∫–æ–Ω—Å–æ–ª–∏
2. –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ `payment_orders`
3. –ë–∞–ª–∞–Ω—Å –≤ —Ç–∞–±–ª–∏—Ü–µ `user_balances`
